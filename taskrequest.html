<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Task Requests | Admin Panel</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
body{
  font-family:'Poppins',sans-serif;
  background:#070b1f;color:#fff;margin:0;padding:20px;
}
h2{text-align:center;color:#fbbf24;margin-bottom:20px;}
.card{
  background:#0f172a;padding:15px;border-radius:14px;
  box-shadow:0 0 10px rgba(0,0,0,0.4);margin-bottom:15px;
}
.proof-link{color:#60a5fa;text-decoration:none;word-break:break-all;}
.btn{
  padding:7px 14px;border:none;border-radius:8px;margin:5px;
  font-weight:600;cursor:pointer;transition:0.3s;
}
.approve{background:#22c55e;color:#fff;}
.reject{background:#ef4444;color:#fff;}
.btn:hover{opacity:0.8;}
</style>
</head>
<body>
<h2>🧾 Pending Task Requests</h2>
<div id="requestList">Loading...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyApIiGovH14024loNQMVTsm_qE3H2Fa658",
  authDomain: "eshopingbddd.firebaseapp.com",
  databaseURL: "https://eshopingbddd-default-rtdb.firebaseio.com",
  projectId: "eshopingbddd",
  storageBucket: "eshopingbddd.appspot.com",
  messagingSenderId: "19777305233",
  appId: "1:19777305233:web:33f3871db06beeaf129d30"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const requestList = document.getElementById('requestList');

// Load all pending submissions
onValue(ref(db, 'submissions'), async snap => {
  const data = snap.val();
  requestList.innerHTML = '';
  if (!data) { requestList.innerHTML = '<p>No requests found.</p>'; return; }

  for (const id of Object.keys(data).reverse()) {
    const s = data[id];
    if (s.status !== 'pending') continue;

    // Get task info
    const taskSnap = await get(ref(db, 'tasks/' + s.taskId));
    const t = taskSnap.exists() ? taskSnap.val() : { title:'Deleted Task', reward:0 };

    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <b style="color:#fbbf24;">${t.title}</b><br>
      👤 UID: ${s.uid}<br>
      💰 Reward: ${t.reward} coins<br>
      🔗 Proof 1: <a class="proof-link" href="${s.proof1}" target="_blank">${s.proof1}</a><br>
      🔗 Proof 2: <a class="proof-link" href="${s.proof2}" target="_blank">${s.proof2}</a><br>
      <button class="btn approve" onclick="approve('${id}','${s.uid}',${t.reward})">✅ Approve</button>
      <button class="btn reject" onclick="reject('${id}')">❌ Reject</button>
    `;
    requestList.appendChild(div);
  }
});

// Approve function
window.approve = async (id, uid, reward) => {
  const subRef = ref(db, 'submissions/' + id);
  const userRef = ref(db, 'users/' + uid);

  const userSnap = await get(userRef);
  let balance = 0;
  if (userSnap.exists()) balance = userSnap.val().balance || 0;

  await update(userRef, { balance: balance + reward });
  await update(subRef, { status: 'approved' });

  alert('✅ Approved! Balance added.');
  location.reload();
};

// Reject function
window.reject = async (id) => {
  await update(ref(db, 'submissions/' + id), { status: 'rejected' });
  alert('❌ Request rejected.');
  location.reload();
};
</script>
</body>

</html>
