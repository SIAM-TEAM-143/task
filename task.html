<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VIP Task Center</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
:root{
  --bg:#070b1f;--card:#0f172a;--accent:#fbbf24;--muted:#9ca3af;--vip:#ffe082;
}
body{
  font-family:'Poppins',sans-serif;
  background:radial-gradient(circle at top,#0b1228,#060a16);
  color:#fff;margin:0;padding-bottom:70px;
}
.header{
  background:linear-gradient(90deg,#0f172a,#162447);
  text-align:center;padding:18px 0;box-shadow:0 3px 15px rgba(0,0,0,0.4);
}
.header h1{margin:0;color:var(--vip);font-size:22px;letter-spacing:1px;text-shadow:0 0 10px #fbbf24;}
.container{max-width:900px;margin:20px auto;padding:10px;}
.card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 25px rgba(0,0,0,0.5);margin-bottom:18px;}
.task{border-bottom:1px solid rgba(255,255,255,0.07);padding:12px 0;display:flex;gap:10px;align-items:center;}
.task img{width:80px;height:80px;border-radius:12px;object-fit:cover;box-shadow:0 0 10px rgba(0,0,0,0.5);}
.task-info{flex:1}
.task-info b{color:var(--vip);font-size:16px;}
.task-info small{color:var(--muted);}
.btn{
  background:var(--accent);color:#000;border:none;
  border-radius:10px;padding:8px 14px;font-weight:600;cursor:pointer;
  transition:0.3s;box-shadow:0 4px 12px rgba(251,191,36,0.4);
}
.btn:hover{transform:scale(1.05);}
.file-upload{width:100%;padding:8px;border-radius:8px;margin:8px 0;border:none;}
.bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:#0f172a;display:flex;justify-content:space-around;padding:10px 0;box-shadow:0 -3px 10px rgba(0,0,0,0.4);}
.bottom-nav a{color:#ccc;text-decoration:none;font-size:13px;text-align:center;flex:1;}
.bottom-nav a.active{color:var(--accent);}
.stats{font-size:13px;color:#9ca3af;margin-top:4px;}
</style>
</head>
<body>
<div class="header"><h1>‚≠ê VIP Task Center ‚≠ê</h1></div>
<div class="container">
  <div class="card">
    <h3 style="color:var(--vip)">Available Tasks</h3>
    <div id="taskList">Loading...</div>
  </div>

  <div class="card" id="proofBox" style="display:none">
    <h3>Submit Proof (Links)</h3>
    <input type="url" id="proof1" placeholder="Proof 1 Image/Video Link" class="file-upload">
    <input type="url" id="proof2" placeholder="Proof 2 Image/Video Link" class="file-upload">
    <button class="btn" id="submitProof">Submit Proof</button>
    <p id="msg"></p>
  </div>
</div>

<div class="bottom-nav">
  <a href="dashboard.html"><i class="fas fa-home"></i>Home</a>
  <a href="task.html" class="active"><i class="fas fa-tasks"></i>Tasks</a>
  <a href="taskhistory.html"><i class="fas fa-clock-rotate-left"></i>History</a>
  <a href="account.html"><i class="fas fa-user-circle"></i>Account</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get, remove } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyApIiGovH14024loNQMVTsm_qE3H2Fa658",
  authDomain: "eshopingbddd.firebaseapp.com",
  databaseURL: "https://eshopingbddd-default-rtdb.firebaseio.com",
  projectId: "eshopingbddd",
  storageBucket: "eshopingbddd.appspot.com",
  messagingSenderId: "19777305233",
  appId: "1:19777305233:web:33f3871db06beeaf129d30"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const uid = localStorage.getItem('uid');
const taskList = document.getElementById('taskList');
const proofBox = document.getElementById('proofBox');
const msg = document.getElementById('msg');
let currentTask = null;

// Load tasks with stats
onValue(ref(db, 'tasks'), async snap => {
  const data = snap.val();
  taskList.innerHTML = '';
  if (!data) { taskList.innerHTML = '<p>No tasks available.</p>'; return; }

  const subsSnap = await get(ref(db, 'submissions'));
  const subs = subsSnap.exists() ? subsSnap.val() : {};

  for (const id of Object.keys(data).reverse()) {
    const t = data[id];
    const doneBy = Object.values(subs).filter(s => s.taskId === id && s.status !== 'rejected');
    const mySubs = doneBy.filter(s => s.uid === uid);
    const completedCount = doneBy.length;
    const userCount = mySubs.length;
    const limit = t.limit || 1;

    // Remove task automatically when total limit reached
    if (completedCount >= t.totalLimit) {
      await remove(ref(db, 'tasks/' + id));
      continue;
    }

    // Skip if user finished personal limit
    if (userCount >= limit) continue;

    const div = document.createElement('div');
    div.className = 'task';
    div.innerHTML = `
      <img src="${t.fileUrl}" alt="task">
      <div class="task-info">
        <b>${t.title}</b>
        <p style="color:#9ca3af">${t.desc}</p>
        <div class="stats">
          üë• Completed: <span style="color:var(--accent)">${completedCount}</span> / ${t.totalLimit}<br>
          üîÅ You done: ${userCount}/${limit} times
        </div>
        <small>üí∞ Reward: ${t.reward} coins</small><br>
        <button class="btn" onclick="startTask('${id}', ${userCount}, ${limit})">Start Task</button>
      </div>
    `;
    taskList.appendChild(div);
  }
});

window.startTask = (id, userCount, limit) => {
  if (userCount >= limit) {
    alert(`‚ùå You already completed this task ${limit} times.`);
    return;
  }
  currentTask = id;
  proofBox.style.display = 'block';
  msg.textContent = '';
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
};

document.getElementById('submitProof').addEventListener('click', async () => {
  if (!uid) return alert('Please login first!');
  if (!currentTask) return alert('Select a task first!');

  const proof1 = document.getElementById('proof1').value.trim();
  const proof2 = document.getElementById('proof2').value.trim();
  if (!proof1 || !proof2) { msg.textContent = '‚ùå Please provide both proof links.'; return; }

  msg.textContent = 'Submitting... Please wait.';

  const subRef = push(ref(db, 'submissions'));
  await set(subRef, { uid, taskId: currentTask, proof1, proof2, status: 'pending', time: Date.now() });

  msg.textContent = '‚úÖ Proof submitted successfully! Waiting for approval.';
  proofBox.style.display = 'none';
});
</script>
</body>
</html>